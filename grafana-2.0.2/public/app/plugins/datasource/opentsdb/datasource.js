/*! grafana - v2.0.2 - 2015-04-22
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","kbn","moment","./queryCtrl"],function(a,b,c){"use strict";var d=a.module("grafana.services");d.factory("OpenTSDBDatasource",["$q","backendSrv","templateSrv",function(d,e,f){function g(a){this.type="opentsdb",this.editorSrc="app/features/opentsdb/partials/query.editor.html",this.url=a.url,this.name=a.name,this.supportMetrics=!0}function h(a,c,d){var e=i(a,d,c),f=[];return b.each(a.dps,function(a,b){f.push([a,1e3*b])}),{target:e,datapoints:f}}function i(a,c,d){if(!b.isUndefined(c)&&c.alias){var e={};return b.each(a.tags,function(a,b){e["tag_"+b]={value:a}}),f.replace(c.alias,e)}var g=a.metric,h=[];return b.isEmpty(a.tags)||b.each(b.pairs(a.tags),function(a){b.has(d,a[0])&&h.push(a[0]+"="+a[1])}),b.isEmpty(h)||(g+="{"+h.join(", ")+"}"),g}function j(b,c){if(!b.metric||b.hide)return null;var d={metric:f.replace(b.metric),aggregator:"avg"};if(b.aggregator&&(d.aggregator=f.replace(b.aggregator)),b.shouldComputeRate&&(d.rate=!0,d.rateOptions={counter:!!b.isCounter},b.counterMax&&b.counterMax.length&&(d.rateOptions.counterMax=parseInt(b.counterMax)),b.counterResetValue&&b.counterResetValue.length&&(d.rateOptions.resetValue=parseInt(b.counterResetValue))),b.disableDownsampling||(c=f.replace(b.downsampleInterval||c),c.match(/\.[0-9]+s/)&&(c=1e3*parseFloat(c)+"ms"),d.downsample=c+"-"+b.downsampleAggregator),d.tags=a.copy(b.tags),d.tags)for(var e in d.tags)d.tags[e]=f.replace(d.tags[e]);return d}function k(a,c){var d;return b.map(a,function(a){return b.findIndex(c,function(c){return c.metric===a.metric&&b.all(c.tags,function(b,c){return d=f.replace(b),a.tags[c]===d||"*"===d})})})}function l(a){return"now"===a?null:(a=c.parseDate(a),a.getTime())}return g.prototype.query=function(a){var c=l(a.range.from),e=l(a.range.to),f=[];b.each(a.targets,function(b){f.push(j(b,a.interval))});var g=b.compact(f);if(b.isEmpty(g)){var i=d.defer();return i.resolve({data:[]}),i.promise}var m={};return b.each(g,function(a){b.each(a.tags,function(a,b){m[b]=!0})}),this.performTimeSeriesQuery(g,c,e).then(function(c){var d=k(c.data,a.targets),e=b.map(c.data,function(b,c){return c=d[c],h(b,m,a.targets[c])});return{data:e}})},g.prototype.performTimeSeriesQuery=function(a,b,c){var d={start:b,queries:a};c&&(d.end=c);var f={method:"POST",url:this.url+"/api/query",data:d};return e.datasourceRequest(f)},g.prototype.performSuggestQuery=function(a,b){var c={method:"GET",url:this.url+"/api/suggest",params:{type:b,q:a}};return e.datasourceRequest(c).then(function(a){return a.data})},g}])});