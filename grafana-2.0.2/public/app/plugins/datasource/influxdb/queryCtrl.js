/*! grafana - v2.0.2 - 2015-04-22
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash"],function(a,b){"use strict";var c=a.module("grafana.controllers");c.controller("InfluxQueryCtrl",["$scope","$timeout","$sce","templateSrv","$q",function(c,d,e,f,g){function h(a){if(0===a)return void c.segments.push(j.newSelectMetric());if(0===c.segments.length)throw"should always have a scope segment?";return b.last(c.segments).fake?g.when([]):c.segments.length%2===1?(c.segments.push(j.newSelectTag()),g.when([])):(c.segments.push(j.newSelectTagValue()),g.when([]))}function i(a){b.each(c.segments,function(b,c){b.focus=a===c})}function j(a){return"*"===a||"*"===a.value?(this.value="*",this.html=e.trustAsHtml('<i class="fa fa-asterisk"><i>'),void(this.expandable=!0)):b.isString(a)?(this.value=a,void(this.html=e.trustAsHtml(this.value))):(this.fake=a.fake,this.value=a.value,this.type=a.type,this.expandable=a.expandable,void(this.html=e.trustAsHtml(f.highlightVariablesAsHtml(this.value))))}c.init=function(){c.segments=c.target.segments||[],c.functionsSelect=["count","mean","sum","min","max","mode","distinct","median","derivative","stddev","first","last","difference"],h(0)},c.toggleQueryMode=function(){c.target.rawQuery=!c.target.rawQuery},c.moveMetricQuery=function(a,d){b.move(c.panel.targets,a,d)},c.duplicate=function(){var b=a.copy(c.target);c.panel.targets.push(b)},c.getAltSegments=function(a){c.altSegments=[];var d,e,g=c.segments[0].value;return 0===a?(d="MEASUREMENTS",e="SHOW MEASUREMENTS"):a%2===1?(d="TAG_KEYS",e="SHOW TAG KEYS FROM "+g):(d="TAG_VALUES",e="SHOW TAG VALUES FROM "+g+" WITH KEY = "+c.segments[c.segments.length-2].value),console.log("getAltSegments: query",e),c.datasource.metricFindQuery(e,d).then(function(a){console.log("get alt segments: response",a),c.altSegments=b.map(a,function(a){return new j({value:a.text,expandable:a.expandable})}),b.each(f.variables,function(a){c.altSegments.unshift(new j({type:"template",value:"$"+a.name,expandable:!0}))})},function(a){c.parserError=a.message||"Failed to issue metric query"})},c.segmentValueChanged=function(a,b){return delete c.parserError,a.expandable?h(b+1).then(function(){i(b+1),c.targetChanged()}):(c.segments=c.segments.splice(0,b+1),i(b+1),void c.targetChanged())},c.targetChanged=function(){if(!c.parserError){c.target.measurement="",c.target.tags={},c.target.measurement=c.segments[0].value;for(var a=1;a+1<c.segments.length;a+=2){var b=c.segments[a].value;c.target.tags[b]=c.segments[a+1].value}c.$parent.get_data()}},j.newSelectMetric=function(){return new j({value:"select metric",fake:!0})},j.newSelectTag=function(){return new j({value:"select tag",fake:!0})},j.newSelectTagValue=function(){return new j({value:"select tag value",fake:!0})}}])});